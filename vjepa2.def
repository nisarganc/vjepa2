Bootstrap: docker
From: dockerhub-mirror3.rrze.uni-erlangen.de/nvidia/cuda:12.8.1-cudnn-devel-ubuntu24.04


%files
    . /


%environment
    # certificates
    export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
    export REQUESTS_CA_BUNDLE=$SSL_CERT_FILE
    export CURL_CA_BUNDLE=$SSL_CERT_FILE

    # conda env
    export PATH=/opt/conda/envs/vjepa-312/bin:$PATH
    export CONDA_DEFAULT_ENV=vjepa-312

    # Google Cloud CLI / gsutil
    export PATH=/usr/lib/google-cloud-sdk/bin:$PATH
    
    # project paths
    export TORCH_HOME=/hnvme/workspace/v106be10-vjepa2/.cache

    # gpu 
    export TF_FORCE_GPU_ALLOW_GROWTH=true



%post
    apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        ffmpeg \
        git \
        libgl1 \
        libglib2.0-0 \
        tree \
        wget \
        ca-certificates \
        apt-transport-https \
        gnupg && \

    # ---- install Google Cloud CLI (includes gsutil) ----
    echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" \
        > /etc/apt/sources.list.d/google-cloud-sdk.list && \
    curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg \
        | gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg && \
    apt-get update && \
    apt-get install -y --no-install-recommends google-cloud-cli && \
    # ---------------------------------------------------

    apt-get clean && rm -rf /var/lib/apt/lists/*

    wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh -O /tmp/miniforge.sh
    bash /tmp/miniforge.sh -b -p /opt/conda
    rm /tmp/miniforge.sh

    . /opt/conda/etc/profile.d/conda.sh
    conda create -y -n vjepa-312 python=3.12
    conda activate vjepa-312

    # install dependencies
    pip install --upgrade pip
    pip install -e .

    # simple move 
    # pip install pyroboplan
    # pip install "git+ssh://git@github.com/utn-air/simple_move.git"

    # clean up
    conda clean --all -y
    rm -rf /root/.cache /opt/conda/pkgs/*


%runscript
    exec "$@"